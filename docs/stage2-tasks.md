# Stage 2: Content Structure - Detailed Tasks

## Overview
**Goal**: Создать структуру для отображения уровней и прохождения уроков
**Timeline**: День 3-4 (примерно 18 часов работы)
**Prerequisite**: Stage 1 завершен, БД готова, типы сгенерированы

---

## Task 2.1: Levels Page Creation (3 часа)

### Цель
Создать главную страницу с картой 10 уровней

### Файлы для создания
- `src/app/(app)/levels/page.tsx` - страница со списком уровней
- `src/components/level/LevelCard.tsx` - карточка одного уровня
- `src/components/level/LevelGrid.tsx` - сетка для карточек

### Файлы для изменения
- `src/components/AppLayout.tsx` - убедиться что ссылка на /levels активна

### Логика реализации
1. **LevelCard** должен:
   - Использовать существующий компонент Card из ui/
   - Показывать: номер уровня, название, описание, статус (locked/available/completed)
   - Иметь props: level (из БД), isLocked, isCompleted, progress
   - При клике переходить на /lesson/[level_id]

2. **LevelGrid** должен:
   - Использовать CSS Grid (как в существующих компонентах)
   - Адаптивная сетка: 1 колонка на мобильных, 2 на планшетах, 3 на десктопах
   - Принимать массив levels и рендерить LevelCard для каждого

3. **Страница levels** должна:
   - Получать данные из таблицы levels через Supabase
   - Получать прогресс пользователя из user_profiles
   - Определять какие уровни доступны (current_level + tier_type)
   - Использовать React Query для кеширования

### Данные из БД
- Таблица `levels` уже содержит 10 уровней
- Поле `user_profiles.current_level` показывает текущий уровень
- Поле `user_profiles.tier_type` определяет доступ (free = 1-3, paid = все)

### Важно
- НЕ создавать новые UI компоненты, использовать из ui/
- Следовать паттернам из существующих страниц (например, storage)
- Использовать существующие хуки для работы с Supabase

---

## Task 2.2: User Progress Tracking (3 часа)

### Цель
Реализовать отслеживание прогресса пользователя

### Файлы для создания
- `src/lib/hooks/useUserProgress.ts` - хук для работы с прогрессом
- `src/lib/hooks/useLevelAccess.ts` - хук для проверки доступа к уровню

### Файлы для изменения
- `src/components/level/LevelCard.tsx` - добавить визуализацию прогресса
- `src/lib/types.ts` - добавить helper типы для прогресса (если нужно)

### Логика реализации
1. **useUserProgress** должен:
   - Получать user_progress для текущего пользователя
   - Возвращать: текущий уровень, пройденные уровни, прогресс по каждому
   - Использовать React Query с ключом ['user-progress', userId]
   - Подписаться на realtime обновления

2. **useLevelAccess** должен:
   - Принимать levelId
   - Проверять: текущий уровень, tier_type, completed_lessons
   - Возвращать: canAccess, isLocked, reason

3. **Обновление LevelCard**:
   - Показывать прогресс если уровень начат (например, 2/3 шага)
   - Использовать существующий Progress компонент из ui/
   - Показывать замок для недоступных уровней

### БД операции
- SELECT из user_progress WHERE user_id = current_user
- JOIN с levels для получения полной информации
- Использовать существующие Supabase клиенты

### Важно
- Следовать паттернам существующих хуков
- Обрабатывать loading и error состояния
- Не дублировать логику авторизации

---

## Task 2.3: Lesson Container Setup (4 часа)

### Цель
Создать основную структуру для прохождения уроков

### Файлы для создания
- `src/app/(app)/lesson/[id]/page.tsx` - динамическая страница урока
- `src/components/lesson/LessonContainer.tsx` - контейнер для урока
- `src/components/lesson/StepIndicator.tsx` - индикатор текущего шага
- `src/components/lesson/NavigationButtons.tsx` - кнопки навигации

### Логика реализации
1. **Страница lesson/[id]**:
   - Получать id из params
   - Проверять доступ через useLevelAccess
   - Загружать lesson_steps для данного уровня
   - Передавать данные в LessonContainer

2. **LessonContainer**:
   - Управлять текущим шагом (URL state через searchParams)
   - Рендерить соответствующий компонент (будут созданы в 2.4)
   - Сохранять прогресс при переходе между шагами
   - Использовать существующий layout (не создавать новый)

3. **StepIndicator**:
   - Показывать шаги: Text → Video → Test → Complete
   - Использовать существующие компоненты Progress или Tabs
   - Выделять текущий шаг

4. **NavigationButtons**:
   - Кнопки "Previous" и "Next"
   - Использовать существующий Button из ui/
   - Блокировать "Next" пока шаг не завершен
   - На последнем шаге показывать "Complete Level"

### Управление состоянием
- Текущий шаг хранить в URL: ?step=1
- Прогресс сохранять в БД при каждом переходе
- Использовать optimistic updates

### Важно
- НЕ создавать сложный state management
- Использовать существующие паттерны навигации
- Следовать структуре других динамических страниц

---

## Task 2.4: Content Display Components (3 часа)

### Цель
Создать компоненты для отображения разных типов контента

### Файлы для создания
- `src/components/lesson/TextContent.tsx` - текстовый контент
- `src/components/lesson/VideoPlayer.tsx` - видео плеер
- `src/components/lesson/TestWidget.tsx` - компонент теста
- `src/components/lesson/CompletionScreen.tsx` - экран завершения

### Логика реализации
1. **TextContent**:
   - Использовать существующий markdown рендерер (если есть)
   - Или простой div с prose классами из Tailwind
   - Поддержка базового форматирования
   - Кнопка "Mark as Read" внизу

2. **VideoPlayer**:
   - Простой YouTube embed (iframe)
   - Responsive wrapper (16:9)
   - Отслеживание просмотра (простой флаг)
   - Использовать существующие стили для media

3. **TestWidget**:
   - Использовать существующие Form компоненты
   - RadioGroup для вариантов ответов
   - Показывать по одному вопросу
   - Сохранять ответы локально до отправки
   - При завершении показывать результат

4. **CompletionScreen**:
   - Поздравление с завершением уровня
   - Использовать существующий Confetti компонент
   - Показывать полученные навыки
   - Кнопка "Go to Next Level"

### Интеграция с контейнером
- Каждый компонент принимает: content, onComplete
- LessonContainer рендерит нужный компонент based on step_type
- Компоненты вызывают onComplete когда пользователь готов идти дальше

### Важно
- Максимально использовать существующие UI компоненты
- НЕ создавать сложную логику валидации
- Следовать существующим паттернам форм

---

## Task 2.5: Seed Content Data (2 часа)

### Цель
Добавить тестовый контент для первых 3 уровней

### Действия через Supabase MCP
1. Для каждого из уровней 1-3 добавить:
   - 3 lesson_steps (text, video, test)
   - 3-5 test_questions для каждого теста
   - Реальные YouTube видео ID
   - Осмысленный текстовый контент

2. Структура контента:
   - Level 1: "Business Model Basics"
   - Level 2: "Market Research"  
   - Level 3: "Financial Planning"

3. Создать тестовые artifacts:
   - По одному файлу на уровень
   - Загрузить через существующий storage
   - Связать через user_artifacts

### SQL примерная структура
```sql
-- Добавить lesson_steps
INSERT INTO lesson_steps (level_id, step_type, content, order_index)

-- Добавить test_questions  
INSERT INTO test_questions (lesson_step_id, question, options, correct_answer)

-- Проверить связи
SELECT * FROM lesson_steps WHERE level_id IN (1,2,3)
```

### Важно
- Использовать реальный образовательный контент
- YouTube видео должны существовать
- Вопросы тестов должны быть по теме урока

---

## Task 2.6: Stage 2 Testing & Refactor (3 часа)

### Цель
Проверить работу всей системы уровней и уроков

### Тесты для написания
1. **E2E тест прохождения урока**:
   - Вход в систему
   - Выбор доступного уровня
   - Прохождение всех шагов
   - Проверка сохранения прогресса

2. **Интеграционные тесты**:
   - useUserProgress возвращает корректные данные
   - useLevelAccess правильно определяет доступ
   - Прогресс сохраняется в БД

3. **Unit тесты**:
   - Компоненты рендерятся без ошибок
   - Навигация между шагами работает
   - Тест засчитывается правильно

### Рефакторинг
- Устранить найденные проблемы
- Оптимизировать запросы к БД
- Улучшить обработку ошибок
- Добавить missing типы

### Обновление документации
- Обновить status.md с результатами
- Документировать API хуков
- Добавить комментарии к сложной логике

### Чек-лист для проверки
- [ ] Можно выбрать доступный уровень
- [ ] Урок загружается корректно
- [ ] Навигация между шагами работает
- [ ] Прогресс сохраняется
- [ ] Тест можно пройти
- [ ] Уровень завершается успешно
- [ ] Следующий уровень разблокируется
- [ ] Free пользователи видят только 3 уровня
- [ ] Нет регрессий в существующем функционале

---

## Итоговый результат Stage 2

После выполнения всех задач должно быть:
1. Рабочая карта уровней с визуализацией прогресса
2. Полноценный flow прохождения урока
3. Сохранение прогресса в БД
4. Контроль доступа на основе tier и прогресса
5. Тестовый контент для проверки
6. Полное покрытие тестами

## Важные напоминания

- **НЕ создавать** новые UI компоненты если есть в ui/
- **НЕ писать** сложную бизнес-логику
- **Использовать** существующие паттерны из шаблона
- **Следовать** структуре других страниц
- **Тестировать** после каждой задачи
- **Коммитить** атомарно
- **Обновлять** status.md