# Stage 3: File Management → Artifacts - Detailed Tasks

## Overview
**Goal**: Адаптировать существующую систему File Management для образовательных артефактов
**Timeline**: День 5-6 (примерно 14 часов работы)
**Prerequisite**: Stage 2 завершен, уроки работают, прогресс сохраняется

## Анализ текущего состояния

### Что у нас есть:
- ✅ Полностью рабочая система storage (File Management)
- ✅ Таблица user_artifacts создана в Stage 1
- ✅ CompletionScreen готов для интеграции с артефактами
- ✅ Система прогресса отслеживает завершение уровней

### Извлеченные уроки из Stage 2:
- Важность useCallback для оптимизации
- Проверки typeof window для SSR
- Правильная работа с Supabase realtime
- Минимальные изменения существующего кода

---

## Task 3.1: Rename File Management (2 часа)

### Цель
Минимально адаптировать UI текст для образовательного контекста

### Файлы для изменения
- `src/app/(app)/storage/page.tsx` - обновить заголовки и описания
- `src/components/AppLayout.tsx` - убедиться что "My Materials" отображается (уже сделано в Stage 1)

### Логика реализации
1. **В storage/page.tsx изменить**:
   - Заголовок с "File Management" на "My Learning Materials"
   - Описание на "Download materials from completed lessons"
   - Текст пустого состояния на "Complete lessons to unlock materials"
   - НЕ менять логику работы

2. **Проверить навигацию**:
   - Пункт меню уже переименован в "My Materials" (Stage 1)
   - Убедиться что ссылка работает

3. **Сохранить функциональность**:
   - Загрузка файлов остается (для будущего админа)
   - Удаление файлов работает
   - Все существующие features сохраняются

### Важно
- НЕ переписывать компоненты
- НЕ менять структуру данных
- Только UI текст и labels

---

## Task 3.2: Link Artifacts to Levels 

### Цель
Связать существующую систему storage с уровнями через user_artifacts

### Файлы для изменения
- `src/app/(app)/storage/page.tsx` - модифицировать запросы
- `src/lib/hooks/useUserArtifacts.ts` - создать новый хук

### БД структура (уже создана)
```
user_artifacts:
- id (uuid)
- user_id (uuid) 
- level_id (integer)
- file_id (uuid) → storage.objects.id
- unlocked_at (timestamp)
```

### Логика реализации
1. **Создать useUserArtifacts хук**:
   - Получать artifacts с JOIN на storage.objects
   - Группировать по level_id
   - Возвращать структуру: { levelId: { title, files: [...] } }
   - Использовать паттерн из useUserProgress

2. **Модифицировать storage/page.tsx**:
   - Использовать useUserArtifacts вместо прямого запроса
   - Показывать файлы сгруппированными по уровням
   - Добавить badges с номером уровня
   - Сохранить существующий UI максимально

3. **Запрос примерная структура**:
   ```sql
   SELECT ua.*, so.*, l.title as level_title
   FROM user_artifacts ua
   JOIN storage.objects so ON ua.file_id = so.id
   JOIN levels l ON ua.level_id = l.id
   WHERE ua.user_id = auth.uid()
   ```

### Важно
- Использовать существующие компоненты для отображения файлов
- НЕ ломать существующую функциональность
- Добавить, а не заменить

---

## Task 3.3: Artifact Download Component 

### Цель
Создать компонент для показа и разблокировки артефакта при завершении уровня

### Файлы для создания
- `src/components/lesson/ArtifactUnlock.tsx` - компонент разблокировки

### Файлы для изменения
- `src/components/lesson/CompletionScreen.tsx` - интегрировать ArtifactUnlock
- `src/components/lesson/LessonContainer.tsx` - передать artifact данные

### Логика реализации
1. **ArtifactUnlock компонент**:
   - Принимает: levelId, artifactData
   - Показывает карточку с описанием артефакта
   - Кнопка "Download Material" 
   - Использует существующий Card из ui/
   - При клике создает запись в user_artifacts и скачивает

2. **Интеграция в CompletionScreen**:
   - Добавить ArtifactUnlock после поздравления
   - Показывать только если есть artifact для уровня
   - Анимация появления (fade in)

3. **Логика разблокировки**:
   - INSERT в user_artifacts при первом завершении
   - Если уже разблокирован - сразу показывать download
   - Использовать существующую логику download из storage

### Данные артефактов
- Пока используем заглушки из artifact_templates (Stage 2)
- В будущем админ загрузит реальные файлы

### Важно
- Использовать существующие UI компоненты
- Следовать паттернам из storage для download
- НЕ усложнять логику

---

## Task 3.4: Profile Integration 

### Цель
Показать разблокированные артефакты в профиле пользователя

### Файлы для изменения
- `src/app/(app)/user-settings/page.tsx` - добавить секцию артефактов
- `src/components/profile/ArtifactsList.tsx` - создать компонент списка

### Логика реализации
1. **Создать ArtifactsList**:
   - Использовать useUserArtifacts хук
   - Показывать компактный список по уровням
   - Переиспользовать стили из существующих списков
   - Кнопка "View All" ведет на /storage

2. **Интегрировать в user-settings**:
   - Добавить секцию "Learning Materials"
   - Разместить после существующих секций
   - Показывать счетчик (3 materials unlocked)
   - Использовать существующий layout

3. **UI структура**:
   ```
   Learning Materials (3 unlocked)
   ├── Level 1: Business Plan Template ✓
   ├── Level 2: Market Research Guide ✓
   └── Level 3: Financial Model Excel ✓
   [View All Materials →]
   ```

### Важно
- Минимальные изменения в user-settings
- Использовать существующие компоненты и стили
- Компактное отображение

---

## Task 3.5: Stage 3 Testing & Refactor

### Цель
Проверить интеграцию артефактов с системой уровней

### Тесты для написания
1. **E2E тест разблокировки артефакта**:
   - Пройти уровень
   - Увидеть артефакт на CompletionScreen
   - Скачать артефакт
   - Проверить появление в /storage

2. **Интеграционные тесты**:
   - useUserArtifacts возвращает правильные данные
   - Артефакты группируются по уровням
   - Download работает корректно

3. **Проверка миграции**:
   - Существующие файлы все еще доступны
   - Новые артефакты правильно связаны
   - RLS политики работают

### Рефакторинг по результатам Stage 2
- Добавить useCallback где нужно
- Проверить SSR совместимость
- Оптимизировать запросы (избежать N+1)
- Обработка ошибок

### Проверки производительности
- Загрузка страницы storage быстрая
- Нет лишних re-renders
- Запросы оптимальны

### Обновление документации
- Обновить status.md
- Документировать useUserArtifacts
- Обновить structure.md если нужно

### Чек-лист для проверки
- [ ] Storage переименован в "My Materials"
- [ ] Артефакты показываются по уровням
- [ ] Разблокировка работает при завершении
- [ ] Скачивание файлов функционирует
- [ ] Профиль показывает артефакты
- [ ] Старый функционал storage не сломан
- [ ] RLS политики корректны
- [ ] Производительность оптимальна

---

## Потенциальные проблемы (учитывая опыт Stage 2)

### 1. Realtime подписки
- Использовать уникальные имена каналов
- Правильно отписываться в cleanup

### 2. Оптимизация запросов
- Избегать N+1 при загрузке артефактов
- Использовать правильные JOIN

### 3. SSR совместимость
- Проверки window для download функций
- Lazy loading где необходимо

### 4. Типизация
- Расширить types.ts если нужно
- Helper типы для артефактов

---

## Итоговый результат Stage 3

После выполнения всех задач:
1. ✅ File Management адаптирован под образовательные материалы
2. ✅ Артефакты привязаны к уровням
3. ✅ Разблокировка при завершении уровня
4. ✅ Интеграция с профилем
5. ✅ Сохранена вся существующая функциональность
6. ✅ Оптимальная производительность

## Ключевые принципы

- **Минимальные изменения** существующего storage
- **Максимальное переиспользование** компонентов
- **Простая логика** без overengineering
- **Учет уроков** из Stage 2
- **Сохранение функциональности** для будущего админа